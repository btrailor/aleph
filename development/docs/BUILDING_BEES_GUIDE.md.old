# Building BEES - Complete Guide

**Date**: 2026-01-10  
**Purpose**: Step-by-step guide for building BEES firmware using Docker

---

## Quick Reference

### One-Command Build

```bash
# From aleph root directory
docker run --rm -v "$(pwd):/aleph" aleph-builder bash -c "cd /aleph/apps/bees && make"
```

### Interactive Shell (for development)

```bash
# Start container with interactive shell
docker run --rm -it -v "$(pwd):/aleph" aleph-builder bash

# Inside container:
cd /aleph/apps/bees
make
```

---

## Prerequisites

### 1. Docker Image

You need the `aleph-builder` Docker image (should already exist):

```bash
# Check if image exists
docker images | grep aleph-builder

# Expected output:
# aleph-builder   latest    582e5c8141a1   2 months ago   1.22GB
```

If image doesn't exist, it needs to be built (see Docker Image Setup section below).

### 2. Working Directory

Be in the aleph project root:

```bash
cd /Users/brettgershon/Documents/01_Projects/02_signals/Audio_Development/aleph
```

---

## Building BEES

### Method 1: Quick Build (Recommended)

**From aleph root directory:**

```bash
docker run --rm -v "$(pwd):/aleph" aleph-builder bash -c "cd /aleph/apps/bees && make"
```

**What this does:**

- `docker run` - Starts a container
- `--rm` - Removes container when done (keeps things clean)
- `-v "$(pwd):/aleph"` - Mounts current directory as /aleph in container
- `aleph-builder` - Uses the aleph-builder image
- `bash -c "..."` - Runs the build command

**Output location:**

- `build-output/app/aleph-bees.hex` - Firmware file

### Method 2: Interactive Development Shell

**Good for multiple builds or debugging:**

```bash
# Start interactive shell
docker run --rm -it -v "$(pwd):/aleph" aleph-builder bash

# You're now inside the container at /aleph
cd apps/bees
make

# To rebuild after changes:
make clean
make

# Exit container when done
exit
```

### Method 3: Named Container (Persistent)

**For long-term development sessions:**

```bash
# Start named container
docker run -it -v "$(pwd):/aleph" --name aleph-dev aleph-builder bash

# Build inside container
cd /aleph/apps/bees
make

# Exit (container stops but persists)
exit

# Restart later:
docker start -i aleph-dev

# Remove when done:
docker rm aleph-dev
```

---

## Common Build Commands

### Inside Container (after cd /aleph/apps/bees):

```bash
# Clean build (removes previous build artifacts)
make clean

# Full build
make

# Build with verbose output
make V=1

# Check for errors only (no build)
make -n

# Parallel build (faster on multi-core)
make -j4
```

---

## Troubleshooting

### Issue: "docker: command not found"

**Solution:** Docker is not running or not installed.

```bash
# Check Docker status
docker --version

# Start Docker Desktop (macOS)
open -a Docker
```

### Issue: "Error response from daemon: No such image: aleph-builder"

**Solution:** Image needs to be built (see Docker Image Setup section).

### Issue: "Permission denied" errors

**Solution:** Files created by Docker are owned by root.

```bash
# Fix permissions after build (from aleph root):
sudo chown -R $(whoami):$(id -gn) build-output/
```

### Issue: Build fails with "No such file or directory"

**Possible causes:**

1. Not in correct directory (should be aleph root when running docker)
2. Volume mount is incorrect
3. Source files missing

**Verify:**

```bash
# Check you're in aleph root
pwd
# Should show: /Users/brettgershon/.../aleph

# Check files exist
ls apps/bees/src/scene.c
```

### Issue: "fatal error: <header>.h: No such file or directory"

**Solution:** Missing dependency or include path issue.

```bash
# Inside container, check toolchain
avr32-gcc --version

# If fails, toolchain may not be built
# (This is unlikely if image was built correctly)
```

---

## Build Artifacts

After successful build, you'll find:

```
build-output/
└── app/
    ├── aleph-bees.elf     # ELF binary
    ├── aleph-bees.hex     # HEX firmware (flash this to Aleph)
    ├── aleph-bees.map     # Memory map
    └── aleph-bees.lss     # Assembly listing
```

**The file you want:** `build-output/app/aleph-bees.hex`

---

## Typical Development Workflow

### 1. Start Container

```bash
cd /path/to/aleph
docker run --rm -it -v "$(pwd):/aleph" aleph-builder bash
```

### 2. Make Changes

(Edit files on your Mac - they're visible in container due to volume mount)

### 3. Build Inside Container

```bash
cd /aleph/apps/bees
make clean && make
```

### 4. Check Output

```bash
ls -lh /aleph/build-output/app/aleph-bees.hex
```

### 5. Fix Errors (if any)

- Read compiler output
- Fix issues in source files (on Mac)
- Rebuild (step 3)

### 6. Exit When Done

```bash
exit
```

---

## Docker Image Setup

**If you need to rebuild the aleph-builder image:**

### Check for Dockerfile

Look for one of these:

```bash
# Check common locations
ls development/docker/Dockerfile*
ls Dockerfile
```

### Build Image

```bash
# If Dockerfile exists at root:
docker build -t aleph-builder .

# If in development/docker/:
docker build -t aleph-builder -f development/docker/Dockerfile.avr32 .
```

**Note:** Building the image takes ~30-60 minutes (compiles AVR32 toolchain from source).

---

## Build Performance

### Timing

- **Clean build:** ~2-3 minutes
- **Incremental build:** ~10-30 seconds (depends on changes)
- **Full rebuild (make clean + make):** ~2-3 minutes

### Optimization

**Use parallel builds:**

```bash
# Inside container
cd /aleph/apps/bees
make -j$(nproc)  # Uses all CPU cores
```

**Cache Docker layers:**

```bash
# Don't use --rm if doing repeated builds
docker run -it -v "$(pwd):/aleph" --name aleph-build aleph-builder bash

# Reuse same container:
docker start -i aleph-build
```

---

## Verifying Build Success

### Check for hex file:

```bash
ls -lh build-output/app/aleph-bees.hex
# Should show: ~200-400KB file
```

### Check build log (last few lines):

```bash
# Should end with:
# "Size after:"
# "   text    data     bss     dec     hex filename"
# "  12345    1234    5678   19257    4b39 aleph-bees.elf"
# "Finished building target: aleph-bees.hex"
```

### Test hex file format:

```bash
head -5 build-output/app/aleph-bees.hex
# Should show Intel HEX format:
# :100000000C9435000C9457000C9457000C945700E2
# :100010000C9457000C9457000C9457000C94570088
```

---

## Clean Up

### Remove build artifacts:

```bash
# Inside container
cd /aleph/apps/bees
make clean

# Or from host
docker run --rm -v "$(pwd):/aleph" aleph-builder bash -c "cd /aleph/apps/bees && make clean"
```

### Remove container:

```bash
docker rm aleph-dev  # If you created named container
```

### Remove image (to force rebuild):

```bash
docker rmi aleph-builder
```

---

## Current Project Status

**Branch:** `feature/scene-migration-0.7.1-to-0.8.x`

**Recent Changes:**

- Added `scene_convert.c` - Scene format conversion (stub implementation)
- Added `scene_convert.h` - Conversion API
- Modified `scene.c` - Integration with conversion
- Updated `config.mk` - Added scene_convert.c to build

**Next Steps:**

1. Build to verify compilation
2. Implement full conversion logic
3. Test with 0.7.1 example scenes

---

## Quick Commands Reference Card

```bash
# Build from host (one command)
docker run --rm -v "$(pwd):/aleph" aleph-builder bash -c "cd /aleph/apps/bees && make"

# Interactive shell
docker run --rm -it -v "$(pwd):/aleph" aleph-builder bash

# Inside container - build
cd /aleph/apps/bees && make

# Inside container - clean build
cd /aleph/apps/bees && make clean && make

# Check hex file
ls -lh build-output/app/aleph-bees.hex

# Fix permissions (from host)
sudo chown -R $(whoami):$(id -gn) build-output/
```

---

## Notes

- **Volume mount:** Changes on Mac are immediately visible in container
- **No git inside container:** Make commits from Mac, not container
- **Build output:** Appears in `build-output/` on Mac (due to volume mount)
- **Permissions:** Files created by container are owned by root (fix with chown)

---

**Last Updated:** 2026-01-10  
**Tested With:** aleph-builder:latest (582e5c8141a1)
